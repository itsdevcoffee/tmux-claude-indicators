#!/bin/bash
# Claude Code thinking animation - cycles through emojis while Claude is thinking
# Usage: claude-thinking-animator <tmux_pane_id>
#
# Uses flock to ensure only ONE animator runs per pane at any time.
# Lock is automatically released when process exits (crash-safe).

PANE="${1:-$TMUX_PANE}"

if [ -z "$PANE" ]; then
    echo "Error: No pane specified"
    exit 1
fi

# Acquire exclusive lock - only one animator per pane allowed
LOCK_FILE="${TMUX_TMPDIR:-/tmp}/claude-animator-${PANE}.lock"
exec 200>"$LOCK_FILE"

# Cleanup: explicitly close lock FD on exit (prevents FD leaks to children)
cleanup() {
    exec 200>&-
}
trap cleanup EXIT INT TERM

# Non-blocking exclusive lock - exit immediately if another animator holds it
if ! flock -n 200; then
    # Another animator is already running for this pane
    exit 0
fi

# We now hold the exclusive lock for this pane

# Animation frames: ðŸ˜œ â†’ ðŸ¤ª â†’ ðŸ˜µâ€ðŸ’« â†’ ðŸ¤ª
FRAMES=("ðŸ˜œ" "ðŸ¤ª" "ðŸ˜µâ€ðŸ’«" "ðŸ¤ª")
FRAME_COUNT=${#FRAMES[@]}
FRAME_INDEX=0

# Interval in milliseconds (140-180ms, using 160ms average)
INTERVAL=0.16

# Keep animating until state changes from "thinking"
while true; do
    # Check if state is still "thinking"
    current_state=$(tmux show-window-option -t "$PANE" -v @claude-state 2>/dev/null)

    if [ "$current_state" != "thinking" ]; then
        # Stop animation if state changed
        exit 0
    fi

    # Update the emoji in @claude-thinking-frame
    tmux set-window-option -t "$PANE" @claude-thinking-frame "${FRAMES[$FRAME_INDEX]}"

    # Move to next frame
    FRAME_INDEX=$(( (FRAME_INDEX + 1) % FRAME_COUNT ))

    # Sleep for interval
    sleep "$INTERVAL"
done
