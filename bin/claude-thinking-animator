#!/usr/bin/env bash
# Claude Code thinking animation - cycles through frames while Claude is thinking
# Usage: claude-thinking-animator <tmux_pane_id>
#
# Uses flock to ensure only ONE animator runs per pane at any time.
# Lock is automatically released when process exits (crash-safe).

PANE="${1:-$TMUX_PANE}"

if [ -z "$PANE" ]; then
    echo "Error: No pane specified"
    exit 1
fi

# Acquire exclusive lock - only one animator per pane allowed
LOCK_FILE="${TMUX_TMPDIR:-/tmp}/claude-animator-${PANE}.lock"
exec 200>"$LOCK_FILE"

# Cleanup: explicitly close lock FD on exit (prevents FD leaks to children)
cleanup() {
    exec 200>&-
}
trap cleanup EXIT INT TERM

# Non-blocking exclusive lock - exit immediately if another animator holds it
if ! flock -n 200; then
    # Another animator is already running for this pane
    exit 0
fi

# We now hold the exclusive lock for this pane

# Read animation frames from tmux option, fallback to braille spinner
# Braille characters are all single-width and identical size - no layout bounce
EMOJI_OPTION=$(tmux show-option -gqv @claude-emoji-thinking 2>/dev/null)

if [ -n "$EMOJI_OPTION" ]; then
    # Split space-separated emoji string into array
    IFS=' ' read -ra FRAMES <<< "$EMOJI_OPTION"
else
    FRAMES=("⠋" "⠙" "⠹" "⠸" "⠼" "⠴" "⠦" "⠧" "⠇" "⠏")
fi

FRAME_COUNT=${#FRAMES[@]}
FRAME_INDEX=0

# Read interval from tmux option (in milliseconds), fallback to 160ms
INTERVAL_MS=$(tmux show-option -gqv @claude-interval 2>/dev/null)
INTERVAL_MS=${INTERVAL_MS:-160}

# Convert milliseconds to seconds for sleep command
INTERVAL=$(echo "scale=3; $INTERVAL_MS / 1000" | bc 2>/dev/null || echo "0.16")

# Keep animating until state changes from "thinking"
while true; do
    # Check if state is still "thinking"
    current_state=$(tmux show-window-option -t "$PANE" -v @claude-state 2>/dev/null)

    if [ "$current_state" != "thinking" ]; then
        # Stop animation if state changed
        exit 0
    fi

    # Update the frame in @claude-thinking-frame
    tmux set-window-option -t "$PANE" @claude-thinking-frame "${FRAMES[$FRAME_INDEX]}"

    # Move to next frame
    FRAME_INDEX=$(( (FRAME_INDEX + 1) % FRAME_COUNT ))

    # Sleep for interval
    sleep "$INTERVAL"
done
